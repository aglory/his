"undefined"!=typeof require&&require;var e=(e,a,t)=>new Promise(((r,n)=>{var o=e=>{try{d(t.next(e))}catch(a){n(a)}},l=e=>{try{d(t.throw(e))}catch(a){n(a)}},d=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,l);d((t=t.apply(e,a)).next())}));import{_ as a,u as t}from"./useTable.7d8a6e5e.js";import{_ as r,a as n}from"./useForm.e9f08473.js";import{P as o}from"./index.24ce52d8.js";import{B as l,u as d,a as i}from"./index.21fd786f.js";import{aL as s,af as u,aJ as m,aM as c,aG as p,aH as b,c as f,b as I,ag as h}from"./index.e1fec598.js";import{a7 as A,m as g,a_ as M,b$ as P,ai as y,bP as v,c0 as S,am as C,B as O,N as D,n as k,O as x,V as B,Q as w,q as E,aj as T,_ as R,x as _,a0 as j,S as N,a1 as L,bv as F,y as U,z as H,av as $}from"./vendor.8be1affb.js";import"./index.1c224cd3.js";/* empty css              */import{h as G}from"./member.b5761d5d.js";import{a as J}from"./product.367ef3c6.js";/* empty css              *//* empty css              *//* empty css              */import"./useContentViewHeight.1cc3b3a8.js";/* empty css              */import"./useSortable.92d684a3.js";/* empty css              *//* empty css              *//* empty css              */const z=[{label:"站点Id",field:"SiteId",component:"Input",colProps:{span:4},show:!1},{label:"流水号",field:"No",component:"Input",colProps:{span:4}},{label:"会员名称",field:"MemberName",component:"Input",colProps:{span:4}},{label:"会员电话",field:"MemberTel",component:"Input",colProps:{span:4}},{label:"操作人帐号",field:"OperatorLoginName",component:"Input",colProps:{span:4}},{label:"创建时间",field:"CreateTime",component:"RangePicker",colProps:{span:6},componentProps:{"show-time":!0}}],q=[{title:"编号",dataIndex:"Id",align:"center",width:80,sorter:!0},{title:"站点Id",dataIndex:"SiteId",align:"right",width:100,sorter:!0,ifShow:!1},{title:"总金额",dataIndex:"Amount",align:"left",width:100,sorter:!0},{title:"优惠金额",dataIndex:"PreferenceAmount",align:"left",width:100,sorter:!0},{title:"余额支付",dataIndex:"BalanceAmount",align:"right",width:100,sorter:!0},{title:"积分支付",dataIndex:"IntegralAmount",align:"right",width:100,sorter:!0},{title:"在线支付",dataIndex:"OnlineAmount",align:"right",width:100,sorter:!0},{title:"现金支付",dataIndex:"CashAmount",align:"right",width:100,sorter:!0},{title:"产生积分",dataIndex:"ProduceIntegral",align:"right",width:100,sorter:!0},{title:"变动后余额",dataIndex:"Balance",align:"right",width:100,sorter:!0},{title:"支付状态",dataIndex:"PayStatus",align:"center",width:160,customRender:({record:e})=>{switch(e.PayStatus){case s.未支付:return A("span",{},s[s.未支付]);case s.已支付:return A("span",{class:"page-color-green"},s[s.已支付]);case s.已退款:return A("span",{class:"page-color-red"},s[s.已退款])}return u(s,e.PayStatus)},filters:m(s,"text","value"),sorter:!0},{title:"备注",dataIndex:"Remark",align:"left",sorter:!0},{title:"创建时间",dataIndex:"CreateTime",width:160,sorter:!0}];var W,K;function V(e,a="modal"){return p.post({url:W.OrderManagerApi,params:e,headers:{"Content-Type":b.FORM_URLENCODED}},{errorMessageMode:a})}m(c),(K=W||(W={})).OrderManagerApi="?control=order&action=orderManager",K.OrderEditor="?control=order&action=orderEditor",K.OrderSave="?control=order&action=orderSave",K.OrderPayEditor="?control=order&action=orderPayEditor",K.OrderPaySave="?control=order&action=orderPaySave";var Q=g({name:"OrderEditorModal",components:{BasicModal:l,BasicForm:r,Form:M,FormItem:P,Input:y,AutoComplete:v,SelectOption:S,Empty:C,Textarea:y.TextArea},emits:["success"],setup(a,{emit:t}){const r=O({Id:0,No:"",MemberId:0,Remark:"",Items:new Array}),n=O({PayStatus:0,MemberLabel:"",MemberName:"",MemberTel:"",AutoCompleteMemberDataSource:new Array,AutoCompleteMemberAjaxHandle:0,AutoCompleteProductDataSource:new Array,AutoCompleteProductAjaxHandle:0}),{createMessage:o}=f(),[l,{setModalProps:i,closeModal:u}]=d((a=>e(this,null,(function*(){r.Id=null==a?0:a.Id,r.MemberId=0,r.Remark="",n.PayStatus=0,n.MemberName="",n.MemberTel="",r.Items=[],n.MemberLabel="",i({confirmLoading:!0,maskClosable:!1,width:800,height:600});try{if(r.Id>0){const e=yield function(e,a="modal"){return p.post({url:W.OrderEditor,params:e,headers:{"Content-Type":b.JSON}},{errorMessageMode:a})}({Id:r.Id});r.MemberId=e.MemberId,r.Remark=e.Remark,r.Items=e.Items,n.PayStatus=e.PayStatus,n.MemberName=e.MemberName,n.MemberTel=e.MemberTel,n.MemberLabel=`${e.MemberName}(${e.MemberTel})`}}catch(e){}i({confirmLoading:!1})}))));function m(){return![0,s.未支付].some((e=>e===n.PayStatus))}return{registerModal:l,handleSubmit:function(){return e(this,null,(function*(){if(m())u();else try{if(0==r.MemberId)return void o.error("未选择会员");if(!r.Items||!r.Items.length)return void o.error("产品不能未空");for(let e=0;e<r.Items.length;e++){let a=r.Items[e];if(0==a.ProductId)return void o.error("未选择产品");if(a.Copies<=0)return void o.error("产品必须大于0");for(let t=e+1;t<r.Items.length;t++){let e=r.Items[t];if(a.ProductId==e.ProductId)return void o.error(`产品${a.ProductShortName}重复`)}}i({confirmLoading:!0});var e={Id:r.Id,MemberId:r.MemberId,Remark:r.Remark,Products:r.Items.map((e=>({Id:e.ProductId,Copies:e.Copies})))},a=yield function(e,a="modal"){return p.post({url:W.OrderSave,params:e,headers:{"Content-Type":b.JSON}},{errorMessageMode:a})}(e);u(),t("success",{Id:a})}catch(n){}finally{i({confirmLoading:!1})}}))},disableOperator:m,formData:r,editData:n,handleMemberSearch:function(e){clearTimeout(n.AutoCompleteMemberAjaxHandle),setTimeout((()=>{G({Keyword:e}).then((e=>{n.AutoCompleteMemberDataSource=e.map((e=>({key:e.Id,value:`${e.Name}(${e.Tel})`})))}))}),800)},handleMemberSelect:function(e,a){r.MemberId=a.key,n.MemberLabel=a.value},handleProductAdd:function(){r.Items.some((e=>0==e.ProductId))||r.Items.push({ProductId:0,ProductShortName:"",Copies:0})},handleProductDelete:function(e){r.Items.splice(e,1)},handleProductSearch:function(a){clearTimeout(n.AutoCompleteMemberAjaxHandle),setTimeout((()=>e(this,null,(function*(){try{const e=yield J({Keyword:a,Type:[]});n.AutoCompleteProductDataSource=e.map((e=>({key:e.Id,value:e.ShortName})))}catch(e){}}))),800)},handleProductSelect:function(e,a){var t=a.key;r.Items.some((e=>e.ProductId==a.key))||(t=0),r.Items.filter((e=>e.ProductId==t)).forEach((e=>{e.ProductId=a.key,e.ProductShortName=a.value,e.Copies=1}))}}}});const X={class:"ProductItem"},Y={class:"ProductName"},Z={class:"ProductCopies"},ee={class:"ProductOperator"},ae=L("删除"),te={key:0,class:"ProductItem"},re=L("添加产品");Q.render=function(e,a,t,r,n,o){const l=D("SelectOption"),d=D("Empty"),i=D("AutoComplete"),s=D("FormItem"),u=D("Input"),m=D("a-button"),c=D("Textarea"),p=D("Form"),b=D("BasicModal");return k(),x(b,N(e.$attrs,{onRegister:e.registerModal,title:"编辑订单",onOk:e.handleSubmit}),{default:B((()=>[w(p,{layout:"horizontal",labelCol:{span:4},wrapperCol:{span:18},class:"OrderEditorModal"},{default:B((()=>[w(s,{label:"会员"},{default:B((()=>[w(i,{value:e.editData.MemberLabel,onSearch:e.handleMemberSearch,onSelect:e.handleMemberSelect,disabled:e.disableOperator()},{options:B((()=>[(k(!0),E(R,null,T(e.editData.AutoCompleteMemberDataSource,(e=>(k(),x(l,{key:e.key,value:e.value},null,8,["value"])))),128))])),notFoundContent:B((()=>[w(d)])),_:1},8,["value","onSearch","onSelect","disabled"])])),_:1}),w(s,{label:"产品"},{default:B((()=>[(k(!0),E(R,null,T(e.formData.Items,((a,t)=>(k(),E("div",X,[_("div",Y,[w(i,{value:a.ProductShortName,onSearch:e.handleProductSearch,onSelect:e.handleProductSelect,disabled:e.disableOperator()},{options:B((()=>[(k(!0),E(R,null,T(e.editData.AutoCompleteProductDataSource,(e=>(k(),x(l,{key:e.key,value:e.value},null,8,["value"])))),128))])),notFoundContent:B((()=>[w(d)])),_:2},1032,["value","onSearch","onSelect","disabled"])]),_("div",Z,[w(u,{value:a.Copies,"onUpdate:value":e=>a.Copies=e,disabled:e.disableOperator()},null,8,["value","onUpdate:value","disabled"])]),_("div",ee,[w(m,{type:"danger",onClick:a=>e.handleProductDelete(t),disabled:e.disableOperator()},{default:B((()=>[ae])),_:2},1032,["onClick","disabled"])])])))),256)),e.disableOperator()?j("",!0):(k(),E("div",te,[_("div",null,[w(m,{type:"primary",onClick:e.handleProductAdd},{default:B((()=>[re])),_:1},8,["onClick"])])]))])),_:1}),w(s,{label:"备注"},{default:B((()=>[w(c,{value:e.formData.Remark,"onUpdate:value":a[0]||(a[0]=a=>e.formData.Remark=a),rows:4,disabled:e.disableOperator()},null,8,["value","disabled"])])),_:1})])),_:1})])),_:1},16,["onRegister","onOk"])};var ne=g({name:"AccountEditorModal",components:{BasicModal:l,Form:M,FormItem:P,Input:y,InputNumber:F},emits:["success"],setup(a,{emit:t}){const r=O({MemberId:0,PreferenceAmount:0,BalanceAmount:0,IntegralAmount:0,OnlineAmount:0,CashAmount:0,ProduceIntegral:0}),n=O({Id:0,Amount:0,MemberBalance:0,MemberIntegral:0,PayStatus:0}),[o,{setModalProps:l,closeModal:i}]=d((a=>e(this,null,(function*(){n.Id=a.Id,l({confirmLoading:!0,maskClosable:!1});try{const e=yield function(e,a="modal"){return p.post({url:W.OrderPayEditor,params:e,headers:{"Content-Type":b.JSON}},{errorMessageMode:a})}({Id:a.Id});r.MemberId=e.MemberId,r.PreferenceAmount=e.PreferenceAmount,r.BalanceAmount=e.BalanceAmount,r.IntegralAmount=e.IntegralAmount,r.OnlineAmount=e.OnlineAmount,r.CashAmount=e.CashAmount,r.ProduceIntegral=e.ProduceIntegral,n.Amount=e.Amount,n.PayStatus=e.PayStatus,n.MemberBalance=e.MemberBalance,n.MemberIntegral=e.MemberIntegral}catch(e){}l({confirmLoading:!1})}))));function u(){return![0,s.未支付].some((e=>e===n.PayStatus))}return{registerModal:o,handleSubmit:function(){return e(this,null,(function*(){if(u())i();else try{l({confirmLoading:!0});var e={Id:n.Id,PreferenceAmount:r.PreferenceAmount,BalanceAmount:r.BalanceAmount,IntegralAmount:r.IntegralAmount,OnlineAmount:r.OnlineAmount,CashAmount:r.CashAmount};yield function(e,a="modal"){return p.post({url:W.OrderPaySave,params:e,headers:{"Content-Type":b.JSON}},{errorMessageMode:a})}(e),i(),t("success")}catch(a){}finally{l({confirmLoading:!1})}}))},disableOperator:u,formData:r,editData:n,EnumPayStatus:s,handAllMemberBalance:function(){n.MemberBalance>n.Amount-r.PreferenceAmount-.01*r.IntegralAmount?r.BalanceAmount=n.Amount-r.PreferenceAmount-.01*r.IntegralAmount:r.BalanceAmount=n.MemberBalance},handAllMemberIntegral:function(){.01*n.MemberIntegral>n.Amount-r.PreferenceAmount?r.IntegralAmount=100*(n.Amount-r.PreferenceAmount):r.IntegralAmount=n.MemberIntegral},handAllOnlineAmount:function(){const e=n.Amount-r.PreferenceAmount-.01*r.IntegralAmount-r.BalanceAmount;r.OnlineAmount=e>0?e:0,r.CashAmount=0},handAllCashAmount:function(){const e=n.Amount-r.PreferenceAmount-.01*r.IntegralAmount-r.BalanceAmount;r.CashAmount=e>0?e:0,r.OnlineAmount=0}}}});const oe={class:"InputGroup"},le=L("全部"),de={key:0},ie=L(" 积分: "),se={class:"InputGroup"},ue=L("全部"),me={key:0},ce=L(" 余额: "),pe={class:"InputGroup"},be=L("全部"),fe={class:"InputGroup"},Ie=L("全部");ne.render=function(e,a,t,r,n,o){const l=D("Input"),d=D("FormItem"),i=D("InputNumber"),s=D("a-button"),u=D("Form"),m=D("BasicModal");return k(),x(m,N(e.$attrs,{onRegister:e.registerModal,title:"付款单",onOk:e.handleSubmit}),{default:B((()=>[w(u,{layout:"horizontal",labelCol:{span:4},wrapperCol:{span:18},class:"OrderPayEditorModal"},{default:B((()=>[w(d,{label:"总金额"},{default:B((()=>[w(l,{value:e.editData.Amount,"onUpdate:value":a[0]||(a[0]=a=>e.editData.Amount=a),disabled:""},null,8,["value"])])),_:1}),w(d,{label:"优惠金额"},{default:B((()=>[w(i,{value:e.formData.PreferenceAmount,"onUpdate:value":a[1]||(a[1]=a=>e.formData.PreferenceAmount=a),disabled:e.disableOperator()},null,8,["value","disabled"])])),_:1}),w(d,{label:"积分支付"},{default:B((()=>[_("div",oe,[w(i,{value:e.formData.IntegralAmount,"onUpdate:value":a[2]||(a[2]=a=>e.formData.IntegralAmount=a),disabled:e.disableOperator()},null,8,["value","disabled"]),w(l,{disabled:!0,addonBefore:"抵扣",value:.01*e.formData.IntegralAmount},null,8,["value"]),w(s,{type:"primary",disabled:0==e.editData.MemberIntegral||e.disableOperator(),onClick:e.handAllMemberIntegral},{default:B((()=>[le])),_:1},8,["disabled","onClick"])]),e.editData.PayStatus==e.EnumPayStatus.未支付?(k(),E("div",de,[ie,_("span",{class:H([e.editData.MemberIntegral>0?"page-color-green":""])},U(e.editData.MemberIntegral),3)])):j("",!0)])),_:1}),w(d,{label:"余额支付"},{default:B((()=>[_("div",se,[w(i,{value:e.formData.BalanceAmount,"onUpdate:value":a[3]||(a[3]=a=>e.formData.BalanceAmount=a),disabled:e.disableOperator()},null,8,["value","disabled"]),w(s,{type:"primary",disabled:0==e.editData.MemberBalance||e.disableOperator(),onClick:e.handAllMemberBalance},{default:B((()=>[ue])),_:1},8,["disabled","onClick"])]),e.editData.PayStatus==e.EnumPayStatus.未支付?(k(),E("div",me,[ce,_("span",{class:H([e.editData.MemberBalance>0?"page-color-green":""])},U(e.editData.MemberBalance),3)])):j("",!0)])),_:1}),w(d,{label:"在线支付"},{default:B((()=>[_("div",pe,[w(i,{value:e.formData.OnlineAmount,"onUpdate:value":a[4]||(a[4]=a=>e.formData.OnlineAmount=a),disabled:e.disableOperator()},null,8,["value","disabled"]),w(s,{type:"primary",disabled:e.editData.PayStatus!=e.EnumPayStatus.未支付,onClick:e.handAllOnlineAmount},{default:B((()=>[be])),_:1},8,["disabled","onClick"])])])),_:1}),w(d,{label:"现金支付"},{default:B((()=>[_("div",fe,[w(i,{value:e.formData.CashAmount,"onUpdate:value":a[5]||(a[5]=a=>e.formData.CashAmount=a),disabled:e.disableOperator()},null,8,["value","disabled"]),w(s,{type:"primary",disabled:e.editData.PayStatus!=e.EnumPayStatus.未支付,onClick:e.handAllCashAmount},{default:B((()=>[Ie])),_:1},8,["disabled","onClick"])])])),_:1})])),_:1})])),_:1},16,["onRegister","onOk"])};var he=g({name:"OrderManager",components:{PageWrapper:o,BasicTable:a,TableAction:n,OrderEditorModal:Q,OrderPayEditorModal:ne},setup(){const[e,{openModal:a}]=i(),[r,{openModal:n}]=i(),o=I(),[l,{reload:d,getRawDataSource:s}]=t({title:"订单管理",canColDrag:!0,showIndexColumn:!1,striped:!0,canResize:!0,columns:q.filter((e=>o.getUserInfo.Type===h.配置员||"SiteId"!==e.dataIndex)),api:V,formConfig:{labelWidth:80,schemas:z.filter((e=>o.getUserInfo.Type===h.配置员||"SiteId"!==e.field))},useSearchForm:!0,showTableSetting:!0,bordered:!0,actionColumn:{width:200,title:"操作",dataIndex:"action",slots:{customRender:"action"},fixed:"right"},showSummary:!0,summaryFunc:()=>{const e=s();return[{Id:"合计",Amount:e.Amount,PreferenceAmount:e.rawDataSource,BalanceAmount:e.BalanceAmount,IntegralAmount:e.IntegralAmount,OnlineAmount:e.OnlineAmount}]}});function u(e){a(!0,null==e?{Id:0}:e)}function m(){d()}return $("Enter",(e=>{var a;e.preventDefault(),"[object HTMLInputElement]"==(null==(a=e.target)?void 0:a.toString())&&m()})),{registerTable:l,handActionColumns:function(e){return[{title:"编辑",icon:"clarity:note-edit-line",onClick:()=>{u(e)}},{title:"账单",icon:"ant-design:pay-circle-outlined",onClick:()=>{!function(e){n(!0,e)}(e)}}]},registerOrderEditorModal:e,registerOrderPayEditorModal:r,handleEdit:u,handleRefresh:m,handleOrderEditorSunccessRefresh:function(e){n(!0,e)}}}});const Ae=L("创建订单");he.render=function(e,a,t,r,n,o){const l=D("a-button"),d=D("TableAction"),i=D("BasicTable"),s=D("OrderEditorModal"),u=D("OrderPayEditorModal"),m=D("PageWrapper");return k(),x(m,{dense:"",contentFullHeight:"",fixedHeight:""},{default:B((()=>[w(i,{onRegister:e.registerTable},{toolbar:B((()=>[w(l,{type:"primary",onClick:a[0]||(a[0]=a=>e.handleEdit(null))},{default:B((()=>[Ae])),_:1})])),action:B((({record:a})=>[w(d,{actions:e.handActionColumns(a)},null,8,["actions"])])),_:1},8,["onRegister"]),w(s,{onRegister:e.registerOrderEditorModal,onSuccess:e.handleOrderEditorSunccessRefresh},null,8,["onRegister","onSuccess"]),w(u,{onRegister:e.registerOrderPayEditorModal,onSuccess:e.handleRefresh},null,8,["onRegister","onSuccess"])])),_:1})};export{he as default};
